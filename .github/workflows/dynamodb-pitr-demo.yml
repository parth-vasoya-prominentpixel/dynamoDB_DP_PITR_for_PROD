name: DynamoDB PITR POC

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev, uat, prod)"
        required: true
        default: "dev"
        type: choice
        options: [dev, uat, prod]

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  TABLE_NAME: poc-dynamodb-pitr-demo

jobs:
  dynamodb-poc:
    runs-on: ubuntu-22.04
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install boto3
        run: pip install boto3

      - name: Run DynamoDB Create/Update POC
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          TABLE_NAME: ${{ env.TABLE_NAME }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          python3 - <<'EOF'
          import boto3, os, time, json

          ENV = os.getenv("ENVIRONMENT")
          REGION = os.getenv("AWS_REGION")
          TABLE_NAME = os.getenv("TABLE_NAME")

          dynamodb = boto3.client("dynamodb", region_name=REGION)

          def table_exists(name):
              try:
                  dynamodb.describe_table(TableName=name)
                  return True
              except dynamodb.exceptions.ResourceNotFoundException:
                  return False

          def wait_for_status(name, desired):
              for _ in range(60):
                  desc = dynamodb.describe_table(TableName=name)
                  if desc["Table"]["TableStatus"] == desired:
                      print(f"âœ… Table {name} reached {desired}")
                      return
                  print(f"â³ Waiting for {desired}...")
                  time.sleep(5)

          def create_or_update_table():
              table_def = {
                  "TableName": TABLE_NAME,
                  "BillingMode": "PAY_PER_REQUEST",
                  "AttributeDefinitions": [
                      {"AttributeName": "id", "AttributeType": "S"}
                  ],
                  "KeySchema": [
                      {"AttributeName": "id", "KeyType": "HASH"}
                  ]
              }

              if not table_exists(TABLE_NAME):
                  print(f"ðŸš€ Creating table: {TABLE_NAME}")
                  if ENV == "prod":
                      table_def["DeletionProtectionEnabled"] = True
                      print("ðŸ”’ Deletion protection enabled for prod")

                  dynamodb.create_table(**table_def)
                  wait_for_status(TABLE_NAME, "ACTIVE")

                  if ENV == "prod":
                      try:
                          print("ðŸ“¦ Enabling PITR (Point-in-Time Recovery, 7 days)...")
                          dynamodb.update_continuous_backups(
                              TableName=TABLE_NAME,
                              PointInTimeRecoverySpecification={
                                  "PointInTimeRecoveryEnabled": True,
                                  "RecoveryPeriodInDays": 7  # âœ… Correct boto3 param
                              }
                          )
                          print("âœ… PITR enabled with 7-day retention.")
                      except Exception as e:
                          print(f"âš ï¸ PITR error: {e}")
                  else:
                      print("Skipping PITR (non-prod).")

                  print("â° Enabling TTL...")
                  dynamodb.update_time_to_live(
                      TableName=TABLE_NAME,
                      TimeToLiveSpecification={
                          "Enabled": True,
                          "AttributeName": "ttl_expire_at"
                      }
                  )
                  print("âœ… TTL enabled.")
              else:
                  print(f"â„¹ï¸ Table {TABLE_NAME} exists. Checking PITR and TTL...")

                  if ENV == "prod":
                      try:
                          desc = dynamodb.describe_continuous_backups(TableName=TABLE_NAME)
                          pitr_desc = desc["ContinuousBackupsDescription"]["PointInTimeRecoveryDescription"]
                          if (pitr_desc.get("PointInTimeRecoveryStatus") != "ENABLED" or
                              pitr_desc.get("RecoveryPeriodInDays") != 7):
                              print("Updating PITR retention to 7 days...")
                              dynamodb.update_continuous_backups(
                                  TableName=TABLE_NAME,
                                  PointInTimeRecoverySpecification={
                                      "PointInTimeRecoveryEnabled": True,
                                      "RecoveryPeriodInDays": 7
                                  }
                              )
                              print("âœ… PITR updated to 7 days.")
                          else:
                              print("âœ… PITR already correctly configured.")
                      except Exception as e:
                          print(f"âš ï¸ PITR check error: {e}")

                  try:
                      ttl = dynamodb.describe_time_to_live(TableName=TABLE_NAME)
                      ttl_status = ttl.get("TimeToLiveDescription", {}).get("TimeToLiveStatus")
                      if ttl_status != "ENABLED":
                          print("Enabling TTL again...")
                          dynamodb.update_time_to_live(
                              TableName=TABLE_NAME,
                              TimeToLiveSpecification={
                                  "Enabled": True,
                                  "AttributeName": "ttl_expire_at"
                              }
                          )
                      else:
                          print("âœ… TTL already enabled.")
                  except Exception as e:
                      print(f"âš ï¸ TTL check error: {e}")

          # === EXECUTE ===
          create_or_update_table()
          print("ðŸŽ‰ POC complete â€” check DynamoDB console.")
          EOF
