name: DynamoDB PITR + Deletion Protection POC

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev, uat, prod)"
        required: true
        default: "dev"
        type: choice
        options: [dev, uat, prod]

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  BASE_TABLE_NAME: poc-dynamodb-pitr-demo

jobs:
  dynamodb-poc:
    runs-on: ubuntu-22.04
    environment:
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install boto3
        run: pip install boto3

      - name: Run DynamoDB PITR + Deletion Protection Demo
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment }}
          BASE_TABLE_NAME: ${{ env.BASE_TABLE_NAME }}
          AWS_REGION: ${{ env.AWS_REGION }}
        run: |
          python3 - <<'EOF'
          import boto3, os, time, json

          ENV = os.getenv("ENVIRONMENT")
          REGION = os.getenv("AWS_REGION")
          BASE_TABLE_NAME = os.getenv("BASE_TABLE_NAME")
          TABLE_NAME = f"{BASE_TABLE_NAME}-{ENV}"
          dynamodb = boto3.client("dynamodb", region_name=REGION)

          def table_exists(name):
              try:
                  dynamodb.describe_table(TableName=name)
                  return True
              except dynamodb.exceptions.ResourceNotFoundException:
                  return False

          def wait_for_status(name, desired, retries=60, interval=5):
              for _ in range(retries):
                  try:
                      desc = dynamodb.describe_table(TableName=name)
                      status = desc["Table"]["TableStatus"]
                      if status == desired:
                          print(f"âœ… Table {name} reached {desired}")
                          return
                      print(f"â³ Waiting for {desired} (current: {status})...")
                      time.sleep(interval)
                  except Exception as e:
                      print(f"âš ï¸ Error while waiting: {e}")
                      time.sleep(interval)
              print(f"âŒ Timeout waiting for table {name} to reach {desired}.")

          def enable_pitr_with_retry(name, retention_days=7, max_attempts=2):
              for attempt in range(1, max_attempts + 1):
                  try:
                      print(f"ðŸ” Enabling PITR (Attempt {attempt}/{max_attempts})...")
                      dynamodb.update_continuous_backups(
                          TableName=name,
                          PointInTimeRecoverySpecification={
                              "PointInTimeRecoveryEnabled": True,
                              "RecoveryPeriodInDays": retention_days
                          }
                      )
                      print(f"âœ… PITR enabled on {name} ({retention_days}-day retention).")
                      return True
                  except dynamodb.exceptions.ContinuousBackupsUnavailableException:
                      if attempt < max_attempts:
                          print(f"â³ PITR not ready yet (attempt {attempt}). Retrying in 10s...")
                          time.sleep(10)
                      else:
                          print(f"âŒ PITR unavailable after {max_attempts} attempts.")
                  except Exception as e:
                      print(f"âš ï¸ PITR enable error: {e}")
                      return False
              return False

          def ensure_deletion_protection(name):
              try:
                  print(f"ðŸ›¡ï¸ Enabling Deletion Protection on {name}...")
                  dynamodb.update_table(
                      TableName=name,
                      DeletionProtectionEnabled=True
                  )
                  print(f"âœ… Deletion Protection enabled on {name}.")
              except Exception as e:
                  if "ValidationException" in str(e) and "already enabled" in str(e).lower():
                      print(f"â„¹ï¸ Deletion protection already enabled.")
                  else:
                      print(f"âš ï¸ Deletion protection error: {e}")

          def create_or_update_table():
              table_def = {
                  "TableName": TABLE_NAME,
                  "BillingMode": "PAY_PER_REQUEST",
                  "AttributeDefinitions": [{"AttributeName": "id", "AttributeType": "S"}],
                  "KeySchema": [{"AttributeName": "id", "KeyType": "HASH"}],
              }

              if not table_exists(TABLE_NAME):
                  print(f"ðŸš€ Creating table: {TABLE_NAME}")
                  if ENV in ("prod", "prd"):
                      table_def["DeletionProtectionEnabled"] = True
                      print("ðŸ”’ Deletion protection enabled for prod during creation.")

                  dynamodb.create_table(**table_def)
                  wait_for_status(TABLE_NAME, "ACTIVE")

                  # Enable PITR + TTL for prod
                  if ENV in ("prod", "prd"):
                      print("ðŸ“¦ Enabling PITR (Point-in-Time Recovery)...")
                      enable_pitr_with_retry(TABLE_NAME)
                  else:
                      print("â„¹ï¸ Non-prod environment â€” skipping PITR.")

                  try:
                      print("â° Enabling TTL on 'ttl_expire_at'...")
                      dynamodb.update_time_to_live(
                          TableName=TABLE_NAME,
                          TimeToLiveSpecification={"Enabled": True, "AttributeName": "ttl_expire_at"},
                      )
                      print("âœ… TTL enabled.")
                  except Exception as e:
                      print(f"âš ï¸ TTL enable error: {e}")

              else:
                  print(f"â„¹ï¸ Table {TABLE_NAME} already exists â€” validating configuration...")

                  if ENV in ("prod", "prd"):
                      ensure_deletion_protection(TABLE_NAME)
                      try:
                          desc = dynamodb.describe_continuous_backups(TableName=TABLE_NAME)
                          pitr = desc["ContinuousBackupsDescription"]["PointInTimeRecoveryDescription"]
                          status = pitr.get("PointInTimeRecoveryStatus")
                          retention = pitr.get("RecoveryPeriodInDays", None)

                          if status == "ENABLED" and retention == 7:
                              print(f"âœ… PITR already enabled (7-day retention).")
                          elif status == "ENABLED" and retention != 7:
                              print(f"âš™ï¸ Updating PITR retention from {retention} to 7 days...")
                              enable_pitr_with_retry(TABLE_NAME)
                          else:
                              print(f"âš™ï¸ PITR currently disabled â€” enabling now...")
                              enable_pitr_with_retry(TABLE_NAME)
                      except Exception as e:
                          print(f"âš ï¸ PITR check error: {e}")
                  else:
                      print("â„¹ï¸ Non-prod environment â€” skipping PITR & deletion protection.")

                  try:
                      ttl = dynamodb.describe_time_to_live(TableName=TABLE_NAME)
                      ttl_status = ttl.get("TimeToLiveDescription", {}).get("TimeToLiveStatus")
                      if ttl_status != "ENABLED":
                          print("âš™ï¸ TTL not enabled â€” enabling now...")
                          dynamodb.update_time_to_live(
                              TableName=TABLE_NAME,
                              TimeToLiveSpecification={"Enabled": True, "AttributeName": "ttl_expire_at"},
                          )
                          print("âœ… TTL re-enabled.")
                      else:
                          print("âœ… TTL already enabled.")
                  except Exception as e:
                      print(f"âš ï¸ TTL check error: {e}")

          # ---------- EXECUTE ----------
          create_or_update_table()
          print(f"ðŸŽ‰ POC complete â€” check DynamoDB console for table: {TABLE_NAME}")
          EOF
