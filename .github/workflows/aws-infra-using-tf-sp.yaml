name: Terraform Infra Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment: dev, uat, prod'
        required: true
        default: 'dev'
        type: choice
        options: [dev, uat, prod]

      action:
        description: 'Choose action: deploy or destroy'
        required: true
        default: 'deploy'
        type: choice
        options: [deploy, destroy]

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: us-east-1
  WORKING_DIRECTORY: resources

# ============================================================
# 1️⃣ SETUP JOB — shared base setup for all actions
# ============================================================
jobs:
  setup:
    name: Setup and Authentication
    runs-on: ubuntu-22.04
    outputs:
      environment: ${{ github.event.inputs.environment }}
      action: ${{ github.event.inputs.action }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup SSH Access
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS Access
        run: aws sts get-caller-identity


# ============================================================
# 2️⃣ PLAN JOB — automatically runs for both deploy & destroy
# ============================================================
  plan:
    name: Terraform Plan (${{ needs.setup.outputs.action }} - ${{ needs.setup.outputs.environment }})
    needs: setup
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -reconfigure -input=false -backend-config="../environments/democompany/us-east-1/${{ needs.setup.outputs.environment }}/backend.tfvars"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Plan
        id: plan
        run: |
          if [ "${{ needs.setup.outputs.action }}" == "deploy" ]; then
            terraform plan -var-file="../environments/democompany/us-east-1/${{ needs.setup.outputs.environment }}/inputs.tfvars" -out=tfplan
          else
            terraform plan -destroy -var-file="../environments/democompany/us-east-1/${{ needs.setup.outputs.environment }}/inputs.tfvars" -out=tfplan
          fi
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Generate Terraform Graph (SVG)
        run: |
          sudo apt-get update && sudo apt-get install -y graphviz
          mkdir -p graph
          terraform graph | dot -Tsvg > graph/terraform-${{ needs.setup.outputs.environment }}.svg
        working-directory: ${{ env.WORKING_DIRECTORY }}

      # Upload both plan and graph artifacts
      - name: Upload Terraform Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.setup.outputs.environment }}
          path: ${{ env.WORKING_DIRECTORY }}/tfplan

      - name: Upload Terraform Graph Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-graph-${{ needs.setup.outputs.environment }}
          path: ${{ env.WORKING_DIRECTORY }}/graph/terraform-${{ needs.setup.outputs.environment }}.svg

      - name: Upload Terraform Logs (Optional)
        if: always()
        run: |
          mkdir -p logs
          terraform show -no-color tfplan > logs/tfplan.txt
        working-directory: ${{ env.WORKING_DIRECTORY }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-logs-${{ needs.setup.outputs.environment }}
          path: ${{ env.WORKING_DIRECTORY }}/logs/tfplan.txt


# ============================================================
# 3️⃣ APPLY JOB — manual approval for DEPLOY
# ============================================================
  apply:
    name: Terraform Apply (${{ needs.setup.outputs.environment }})
    needs: [setup, plan]
    if: ${{ needs.setup.outputs.action == 'deploy' }}
    runs-on: ubuntu-22.04
    environment:
      name: ${{ needs.setup.outputs.environment }}
      # ✅ set up environment protection rule for manual approval before apply

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.setup.outputs.environment }}
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Init
        run: terraform init -reconfigure -input=false -backend-config="../environments/democompany/us-east-1/${{ needs.setup.outputs.environment }}/backend.tfvars"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Apply (Approved)
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}


# ============================================================
# 4️⃣ DESTROY JOB — manual approval for DESTROY
# ============================================================
  destroy:
    name: Terraform Destroy (${{ needs.setup.outputs.environment }})
    needs: [setup, plan]
    if: ${{ needs.setup.outputs.action == 'destroy' }}
    runs-on: ubuntu-22.04
    environment:
      name: ${{ needs.setup.outputs.environment }}
      # ✅ manual approval via environment protection rule

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.OIDC_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.setup.outputs.environment }}
          path: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Init
        run: terraform init -reconfigure -input=false -backend-config="../environments/democompany/us-east-1/${{ needs.setup.outputs.environment }}/backend.tfvars"
        working-directory: ${{ env.WORKING_DIRECTORY }}

      - name: Terraform Destroy (Approved)
        run: terraform apply -auto-approve tfplan
        working-directory: ${{ env.WORKING_DIRECTORY }}
